version: "3.9"

services:
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: ${API_PORT:-4000}
      TZ: ${TZ:-America/Sao_Paulo}
      DATABASE_URL: ${DATABASE_URL:-file:./data/dev.db}
      JWT_SECRET: ${JWT_SECRET:-}
      FACIAL_THRESHOLD: ${FACIAL_THRESHOLD:-0.90}
      DEVICE_TOKEN: ${DEVICE_TOKEN:-local-demo}
      ENABLE_SHEETS: ${ENABLE_SHEETS:-false}
      GOOGLE_SERVICE_ACCOUNT_EMAIL: ${GOOGLE_SERVICE_ACCOUNT_EMAIL:-}
      GOOGLE_SERVICE_ACCOUNT_KEY: ${GOOGLE_SERVICE_ACCOUNT_KEY:-}
      GOOGLE_SHEETS_SPREADSHEET_ID: ${GOOGLE_SHEETS_SPREADSHEET_ID:-}
      GOOGLE_SHEETS_TAB: ${GOOGLE_SHEETS_TAB:-Registros}
      UPLOAD_DIR: ${UPLOAD_DIR:-/app/data/uploads}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports:
      - "${API_PORT:-4000}:4000"
    command: >
      sh -c "mkdir -p data data/uploads &&
             npx prisma migrate deploy &&
             node dist/main.js"
    volumes:
      - api_data:/app/data
    networks:
      - timeclock

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_DEVICE_TOKEN: ${DEVICE_TOKEN:-local-demo}
    ports:
      - "${WEB_PORT:-8080}:80"
    depends_on:
      - api
    networks:
      - timeclock

networks:
  timeclock:
    driver: bridge

volumes:
  api_data:
